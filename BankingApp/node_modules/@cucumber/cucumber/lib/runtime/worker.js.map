{"version":3,"file":"worker.js","sourceRoot":"","sources":["../../src/runtime/worker.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'node:events'\nimport {\n  Envelope,\n  IdGenerator,\n  TestStepResult,\n  TestStepResultStatus,\n} from '@cucumber/messages'\nimport { AssembledTestCase } from '../assemble'\nimport { SupportCodeLibrary } from '../support_code_library_builder/types'\nimport UserCodeRunner from '../user_code_runner'\nimport { doesHaveValue, valueOrDefault } from '../value_checker'\nimport TestRunHookDefinition from '../models/test_run_hook_definition'\nimport { formatLocation } from '../formatter/helpers'\nimport StepDefinitionSnippetBuilder from '../formatter/step_definition_snippet_builder'\nimport { retriesForPickle, shouldCauseFailure } from './helpers'\nimport TestCaseRunner from './test_case_runner'\nimport { runInTestRunScope } from './scope'\nimport { formatError } from './format_error'\nimport { create, timestamp } from './stopwatch'\nimport { RuntimeOptions } from './types'\n\nexport interface RunHookResult {\n  result: TestStepResult\n  error?: any\n}\n\nexport class Worker {\n  constructor(\n    private readonly testRunStartedId: string,\n    private readonly workerId: string | undefined,\n    private readonly eventBroadcaster: EventEmitter,\n    private readonly newId: IdGenerator.NewId,\n    private readonly options: RuntimeOptions,\n    private readonly supportCodeLibrary: SupportCodeLibrary,\n    private readonly snippetBuilder: StepDefinitionSnippetBuilder\n  ) {}\n\n  private async runTestRunHook(\n    hookDefinition: TestRunHookDefinition\n  ): Promise<RunHookResult> {\n    const testRunHookStartedId = this.newId()\n    this.eventBroadcaster.emit('envelope', {\n      testRunHookStarted: {\n        testRunStartedId: this.testRunStartedId,\n        workerId: this.workerId,\n        id: testRunHookStartedId,\n        hookId: hookDefinition.id,\n        timestamp: timestamp(),\n      },\n    } satisfies Envelope)\n\n    let result: TestStepResult\n    let error: any\n    if (this.options.dryRun) {\n      result = {\n        duration: {\n          seconds: 0,\n          nanos: 0,\n        },\n        status: TestStepResultStatus.SKIPPED,\n      }\n    } else {\n      const stopwatch = create().start()\n      const context = { parameters: this.options.worldParameters }\n      const { error: rawError } = await runInTestRunScope({ context }, () =>\n        UserCodeRunner.run({\n          argsArray: [],\n          fn: hookDefinition.code,\n          thisArg: context,\n          timeoutInMilliseconds: valueOrDefault(\n            hookDefinition.options.timeout,\n            this.supportCodeLibrary.defaultTimeout\n          ),\n        })\n      )\n      const duration = stopwatch.stop().duration()\n\n      if (doesHaveValue(rawError)) {\n        result = {\n          duration,\n          status: TestStepResultStatus.FAILED,\n          ...formatError(rawError, this.options.filterStacktraces),\n        }\n        error = this.wrapTestRunHookError(\n          'a BeforeAll',\n          formatLocation(hookDefinition),\n          rawError\n        )\n      } else {\n        result = {\n          duration,\n          status: TestStepResultStatus.PASSED,\n        }\n      }\n    }\n\n    this.eventBroadcaster.emit('envelope', {\n      testRunHookFinished: {\n        testRunHookStartedId,\n        result,\n        timestamp: timestamp(),\n      },\n    } satisfies Envelope)\n\n    return {\n      result,\n      error,\n    }\n  }\n\n  private wrapTestRunHookError(\n    name: string,\n    location: string,\n    error: any\n  ): any | undefined {\n    if (!doesHaveValue(error)) {\n      return undefined\n    }\n    let message = `${name} hook errored`\n    if (this.workerId) {\n      message += ` on worker ${this.workerId}`\n    }\n    message += `, process exiting: ${location}`\n    return new Error(message, { cause: error })\n  }\n\n  async runBeforeAllHooks(): Promise<RunHookResult[]> {\n    const results: RunHookResult[] = []\n    for (const hookDefinition of this.supportCodeLibrary\n      .beforeTestRunHookDefinitions) {\n      const result = await this.runTestRunHook(hookDefinition)\n      results.push(result)\n      if (doesHaveValue(result.error)) {\n        throw result.error\n      }\n    }\n    return results\n  }\n\n  async runTestCase(\n    { gherkinDocument, pickle, testCase }: AssembledTestCase,\n    failing: boolean\n  ): Promise<boolean> {\n    const testCaseRunner = new TestCaseRunner({\n      workerId: this.workerId,\n      eventBroadcaster: this.eventBroadcaster,\n      newId: this.newId,\n      gherkinDocument,\n      pickle,\n      testCase,\n      retries: retriesForPickle(pickle, this.options),\n      skip: this.options.dryRun || (this.options.failFast && failing),\n      filterStackTraces: this.options.filterStacktraces,\n      supportCodeLibrary: this.supportCodeLibrary,\n      worldParameters: this.options.worldParameters,\n      snippetBuilder: this.snippetBuilder,\n    })\n\n    const status = await testCaseRunner.run()\n\n    return !shouldCauseFailure(status, this.options)\n  }\n\n  async runAfterAllHooks(): Promise<RunHookResult[]> {\n    const results: RunHookResult[] = []\n    const reversed = [\n      ...this.supportCodeLibrary.afterTestRunHookDefinitions,\n    ].reverse()\n    for (const hookDefinition of reversed) {\n      const result = await this.runTestRunHook(hookDefinition)\n      results.push(result)\n      if (doesHaveValue(result.error)) {\n        throw result.error\n      }\n    }\n    return results\n  }\n}\n"]}